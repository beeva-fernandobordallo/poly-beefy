<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Login Dependencies -->
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<!-- App Shell dependencies -->
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<dom-module id="pfe-app">
	<template>
		<style include="iron-flex iron-flex-alignment">
		<style>:host {
			display: block;
		}
		
		#loginContainer {
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin-top: 100px;
			text-align: center;
		}
		
		paper-drawer-panel {
			--paper-drawer-panel-drawer-container: {
				background-color: #eee;
				border-right: 1px solid #998;
			}
			;
		}
		
		.profile-img-holder {
			border-radius: 50%;
			width: 35px;
			height: 35px;
		}
		</style>
		<!-- Routing Elements START -->
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{routeTail}}">
		</app-route>
		<!-- Routing Elements END -->
		<!-- Login Page START-->
		<div id="loginContainer" hidden$="{{userActive}}">
			<div class="login-display-block">
				<iron-image src="/img/logo-BEEVA-vertical-72-300x192.png" preload fade></iron-image>
				<h4>Portal de Formaci√≥n Externa</h4>
				<paper-button raised on-tap="_openLogin">Login</paper-button>
				<br>
				<br>
				<span><small><i>(Acceso con tu cuenta @beeva)</i></small></span>
			</div>
		</div>
		<!-- Login Page END-->
		<!-- Application Page START -->
		<div hidden$="{{!userActive}}">
			<paper-drawer-panel id="drawerPanel">
				<paper-header-panel drawer>
					<paper-toolbar>
						<div>PFE Menu</div>
					</paper-toolbar>
					<div>
						<a href="/catalogo">Link Catalogo</a>
					</div>
				</paper-header-panel>
				<paper-header-panel main>
					<paper-toolbar>
						<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
						<span class="title">{{pageTitle}}</span>
						<paper-menu-button horizontal-align="right">
							<div class="dropdown-trigger">
								<iron-image class="profile-img-holder" src="{{user.img}}" preload sizing="contain"></iron-image>
							</div>
							<paper-menu class="dropdown-content">
								<paper-item>Share</paper-item>
								<paper-item>Settings</paper-item>
								<paper-item>Help</paper-item>
							</paper-menu>
						</paper-menu-button>
					</paper-toolbar>
					<div class="content">
						<span id="scrollAnchor" class="hidden"></span>
						<iron-pages selected="[[page]]" attr-for-selected="data-route">
							<section data-route="">
								Empty
							</section>
							<section data-route="catalogo">
								Catalogo
							</section>
							<section data-route=""></section>
						</iron-pages>
					</div>
				</paper-header-panel>
			</paper-drawer-panel>
		</div>
		<!-- Application Page END -->
	</template>
	<script>
	Polymer({

		is: 'pfe-app',

		properties: {
			userActive: {
				type: Boolean,
				value: false
			},

			page: {
				type: String,
				observer: '_pageChanged'
			}
		},

		observers: [
			'_computeUserData(user, token)',
			'_routeChange(routeData.page)'
		],

		/*App Lifecycle methods*/
		ready: function() {
			if (this.user && this.token) {
				this.userActive = true;
			}
		},

		/**
		 * Observes User and Token data
		 * @param  {Object} user User details
		 * @param  {String} token Authentication token
		 */
		_computeUserData: function(user, token) {
			if (user && token) {
				this.userActive = true;
			} else {
				this.userActive = false;
			}
		},

		/**
		 * Open a pop up window to login users with a google account
		 */
		_openLogin: function() {
			window.open(window.location.origin + '/api/auth/google', '', 'width=1000,height=800');
		},

		_pageChanged: function(page) {
			if (!this.userActive) {
				this._ensureLazyLoaded();
				this.set('route.path', '/');
				return;
			}
			if (page != null && page !== '') {
				this.importHref(
					this.resolveUrl('pfe-' + page + '.html'),
					function() {
						this._pageLoaded();
					}, null, true);
			}
		},

		_pageLoaded: function() {
			this._ensureLazyLoaded();
		},

		_routeChange: function(route) {
			// Abstract
			this.page = route;
			if (this.$.scrollAnchor) {
				this.$.scrollAnchor.scrollIntoView();
			}
			if (this.$.drawerPanel) {
				this.$.drawerPanel.closeDrawer();
			}
		},

		_ensureLazyLoaded: function() {
			// load lazy resources after render and set `loadComplete` when done.
			if (!this.loadComplete) {
				Polymer.RenderStatus.afterNextRender(this, function() {
					this.importHref(this.resolveUrl('lazy-resources.html'), function() {
						this.loadComplete = true;
					});
				});
			}
		},

	});
	</script>
</dom-module>

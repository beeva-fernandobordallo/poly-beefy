<link rel="import" href="../../bower_components/polymer/polymer.html">
<!-- Login Dependencies -->
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<!-- App Shell dependencies -->
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="pfe-home.html">

<dom-module id="pfe-app">
	<template>
		<style include="iron-flex iron-flex-alignment">
		<style>:host {
			display: block;
		}
		
		#loginContainer {
			position: absolute;
			top: 0;
			bottom: 0;
			left: 0;
			right: 0;
			margin-top: 100px;
			text-align: center;
		}
		
		paper-drawer-panel {
			--paper-drawer-panel-drawer-container: {
				border-right: 1px solid #998;
			};
		}

		paper-toolbar.main-toolbar{
			--paper-toolbar-background: #DAE253;
			--paper-toolbar-title: {
				color: #333333;
			};
		}

		paper-toolbar.drawer-toolbar{
			--paper-toolbar-background: #fff;
			--paper-toolbar-title: {
				color: #333333;
			};
		}
		
		.profile-img-holder {
			border-radius: 50%;
			width: 35px;
			height: 35px;
			-webkit-box-shadow: 0 8px 6px -6px black;
			-moz-box-shadow: 0 8px 6px -6px black;
			box-shadow: 0 8px 6px -6px black;
		}

		.menu-logo-holder {
			height: 60px;
		}

		a {
			color: #333333;
			text-decoration:none; 
			cursor:pointer; 
		}
		</style>
		<!-- Routing Elements START -->
		<app-location route="{{route}}"></app-location>
		<app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{routeTail}}">
		</app-route>
		<!-- Routing Elements END -->
		<!-- Media Query Controls START -->
		<iron-media-query query="max-width: 640px" query-matches="{{smallScreen}}">
		</iron-media-query>
		<iron-media-query query="min-width: 1200px" query-matches="{{largeScreen}}">
		</iron-media-query>
		<!-- Media Query Controls END -->

		<!-- Login Page START-->
		<div id="loginContainer" hidden$="{{userActive}}">
			<div class="login-display-block">
				<iron-image src="/img/logo-BEEVA-vertical-72-300x192.png" preload fade></iron-image>
				<h4>Portal de Formación Externa</h4>
				<paper-button raised on-tap="_openLogin">Login</paper-button>
				<br>
				<br>
				<span><small><i>(Acceso con tu cuenta @beeva)</i></small></span>
			</div>
		</div>
		<!-- Login Page END-->

		<!-- Application Page START -->
		<div hidden$="{{!userActive}}">
			<paper-drawer-panel id="drawerPanel">
				<paper-header-panel drawer mode="seamed">
					<paper-toolbar class="drawer-toolbar">
						<img class="menu-logo-holder" src="/img/logo-BEEVA-horizontal-72-300x96.png" preload sizing="contain"></img>
					</paper-toolbar>
					<div>
						<paper-menu>
							<a href="/"><paper-item>
								<iron-icon icon="home"></iron-icon> 
								<span class="flex"></span>
								Inicio
								<span class="flex"></span>
							</paper-item></a>
							<a href="/catalogo"><paper-item>
								<iron-icon icon="view-list"></iron-icon>
								<span class="flex"></span>
								Catálogo
								<span class="flex"></span>
							</paper-item></a>
							<a href="/mis-cursos"><paper-item>
								<iron-icon icon="flight-takeoff"></iron-icon>
								<span class="flex"></span>
								Mis Cursos
								<span class="flex"></span>
							</paper-item></a>
							<a href="/buzon"><paper-item>
								<iron-icon icon="mail"></iron-icon>
								<span class="flex"></span>
								Buzón
								<span class="flex"></span>
							</paper-item></a>
							<template is="dom-if" if="{{admin}}">
								<hr>
								<a href="/admin-courses"><paper-item>
									<iron-icon icon="build"></iron-icon>
									<span class="flex"></span>
									Administrar Cursos
									<span class="flex"></span>
								</paper-item></a>
							</template>
							<hr>
							<paper-item on-tap="logout">
								<iron-icon icon="lock"></iron-icon>
								<span class="flex"></span>
								Logout
								<span class="flex"></span>
							</paper-item>
						</paper-menu>
					</div>
				</paper-header-panel>
				<paper-header-panel main>
					<paper-toolbar class="main-toolbar">
						<paper-icon-button icon="menu" paper-drawer-toggle></paper-icon-button>
						<span class="title">{{pageTitle}}</span>
						<div>
							<iron-image class="profile-img-holder" src="{{user.img}}" preload sizing="contain"></iron-image>
						</div>
					</paper-toolbar>
					<div class="content">
						<span id="scrollAnchor" class="hidden"></span>
						<iron-pages selected="[[page]]" attr-for-selected="data-route">
							<section data-route="">
								<pfe-home token="[[token]]"></pfe-home>
							</section>
							<section data-route="catalogo">
								<pfe-catalogo token="[[token]]"></pfe-catalogo>
							</section>
							<section data-route="mis-cursos">
								<pfe-miscursos token="[[token]]"></pfe-miscursos>
							</section>
							<section data-route="buzon">
								<pfe-buzon token="[[token]]"></pfe-buzon>
							</section>
							<template is="dom-if" if="{{admin}}">
								<section data-route="admin-courses">
									<pfe-admin-courses token="[[token]]"></pfe-admin-courses>
								</section>
							</template>
						</iron-pages>
					</div>
				</paper-header-panel>
			</paper-drawer-panel>

			<paper-toast id="app-toast" text="{{toastMsg}}"></paper-toast>

		</div>
		<!-- Application Page END -->
	</template>
	<script>
	Polymer({

		is: 'pfe-app',

		properties: {
			userActive: {
				type: Boolean,
				value: false
			},

			page: {
				type: String,
				observer: '_pageChanged'
			},

			pageWhitList: {
				type: Array,
				value: function(){
					return [
						'',
						'/',
						'catalogo',
						'mis-cursos',
						'buzon',
						'admin-courses'
					];
				}
			},

			pageTitles: {
				type: Object,
				value: function(){
					return {
						'': 'BEE an Expert - Formación Externa',
						'catalogo': 'Catálogo de Cursos / Certificaciones',
						'mis-cursos': 'Portfolio Personal',
						'buzon': 'Buzón PFE',
						'admin-courses': 'Administrar Cursos'
					};
				}
			}
		},

		observers: [
			'_computeUserData(user, token)',
			'_routeChange(routeData.page)'
		],

		listeners: {
			'new-toast': '_setupToast'
		},

		/*App Lifecycle methods*/
		ready: function() {
			if (this.user && this.token) {
				this.userActive = true;
			}
		},

		/*App methods*/

		/**
		 * Logout methods fires 'logout' event and is handled in the index
		 */
		logout: function(){
			this.fire('logout');
			this.set('route.path', '/');
		},

		/**
		 * Observes User and Token data
		 * @param  {Object} user User details
		 * @param  {String} token Authentication token
		 */
		_computeUserData: function(user, token) {
			if (user && token) {
				this.userActive = true;
				this._userRole();
			} else {
				this.userActive = false;
			}
		},

		_userRole(){
			if(this.user.role && this.user.role.indexOf('admin') !== -1){
				this.admin = true;
			}
		},

		/**
		 * Open a pop up window to login users with a google account
		 */
		_openLogin: function() {
			var dimensions = 'width=' + window.screen.availWidth + ',height=' + window.screen.availHeight;
			window.open(window.location.origin + '/api/auth/google', '', dimensions);
		},

		_pageChanged: function(page) {
			if(!this._checkWhitList(page)){
				this.set('route.path', '/');
				return;
			}
			this._setPageTitle(page);
			if (!this.userActive) {
				this._ensureLazyLoaded();
				this.set('route.path', '/');
				return;
			}
			if (page != null && page !== '') {
				this.importHref(
					this.resolveUrl('pfe-' + page + '.html'),
					function() {
						this._pageLoaded();
					}, null, true);
			}
		},

		_pageLoaded: function() {
			this._ensureLazyLoaded();
		},

		_routeChange: function(route) {
			// Abstract
			this.page = route;
			if (this.$.scrollAnchor) {
				this.$.scrollAnchor.scrollIntoView();
			}
			if (this.$.drawerPanel) {
				this.$.drawerPanel.closeDrawer();
			}
		},

		_ensureLazyLoaded: function() {
			// load lazy resources after render and set `loadComplete` when done.
			if (!this.loadComplete) {
				Polymer.RenderStatus.afterNextRender(this, function() {
					this.importHref(this.resolveUrl('lazy-resources.html'), function() {
						this.loadComplete = true;
					});
				});
			}
		},

		_sectionLoaded: function(e){
			this.pageTitle = e.detail.title;
		},

		_checkWhitList: function(page){
			if(this.pageWhitList.indexOf(page) !== -1){
				return true;
			}
			return false;
		},

		_setPageTitle: function(page){
			this.pageTitle = this.pageTitles[page];
		},

		_setupToast: function (event) {
			this.toastMsg = event.detail.message;
			this.$['app-toast'].open();
		}

	});
	</script>
</dom-module>

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/serv-location/serv-location-behavior.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/pfe-course-card/pfe-course-card.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/pfe-xhr/pfe-xhr.html">
<dom-module id="pfe-admin-courses">
	<template>
		<style include="iron-flex iron-flex-alignment"></style>
		<style>
			.admin-subtitle{
				margin-left: 20px;
				margin-right: 20px;
				padding: 5px;
			}

			.admin-block{
				margin-bottom: 10px;
				margin-left: 1%;
				margin-right: 1%;
				padding: 10px;
				width: 100%;
			}

			#create-dialog{
				width:80%;
			}

			paper-icon-button{
				--paper-icon-button-ink-color: green;
			}

			paper-fab {
				--paper-fab-background: red;
				--paper-fab: {
					position: fixed;
					bottom: 20px;
					right: 20px;
				};
			}

			.error{
				color: red;
			}

			#course-admin-block{
				margin: 0 10px;
			}

			.indent{
				margin-left: 15px;
			}
			
			/* Landscape phones and down */
			@media (max-width: 480px) {
			
			}
			
			/* Landscape phone to portrait tablet */
			@media (min-width: 767px) {
				.admin-block{
					width: 44%;
				}
			}

			/* Portrait tablet to landscape and desktop  - and (max-width: 979px) */
			@media (min-width: 970px) {
				.admin-block{
					width: 28%;
				}
			}
			
		</style>

		<!-- DATA ACCESS ELEMENT -->
		<pfe-xhr id="xhr-element" on-data="_xhrDataReceived" on-error="_xhrError"></pfe-xhr>

		<!-- PAGE HEADER -->
		<div class="layout vertical center">
			<h1>Gestión de Cursos</h1>
		</div>

		<!-- DRAFT SECTION -->
		<h2 class="indent">Borradores</h2>
		<div id="course-admin-block" class="layout vertical">
			<template is="dom-repeat" items="{{draft}}">
				<pfe-course-card course="[[item]]"></pfe-course-card>
			</template>
		</div>

		<!-- ACTIVE SECTION -->
		<h2 class="indent">Cursos Visibles</h2>
		<div id="course-admin-block" class="layout vertical">
			<template is="dom-repeat" items="{{active}}">
				<pfe-course-card course="[[item]]"></pfe-course-card>
			</template>
		</div>

		<!-- BLOCKED SECTION -->
		<h2 class="indent">Cursos Bloqueados</h2>
		<div id="course-admin-block" class="layout vertical">
			<template is="dom-repeat" items="{{blocked}}">
				<pfe-course-card course="[[item]]"></pfe-course-card>
			</template>
		</div>

		<!-- Jump at the end (FOOTER LIKE) -->
		<div style="height:100px"></div>

		<!-- ADD FAB ICON -->
		<paper-fab icon="add" on-tap="_openCreateDialog"></paper-fab>

			

		<!-- CREATE DIALOG -->
		<paper-dialog id="create-dialog" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
			<div class="layout horizontal center">
				<h2>Añadir Curso</h2>
				<span class="flex"></span>
				<template is="dom-if" if="{{createError}}">
					<span class="error">¡Error en la creación!</span>
				</template>
				<template is="dom-if" if="{{editError}}">
					<span class="error">¡Error en la edición!</span>
				</template>
			</div>

			<paper-dialog-scrollable>
				<paper-input id="create-name" label="Nombre" autofocus></paper-input>
				<paper-input id="create-entity" label="Entidad" placeholder="¿Que empresa lo imparte?"></paper-input>
				<paper-input id="create-url" label="Url"></paper-input>
				<paper-input id="create-cost" label="Precio" type="number">
					<div suffix>€</div>
				</paper-input>
				<paper-input id="create-limit" label="Limite de Alumnos" type="number" placeholder="0 = Sin limite; >0 = Limitado"></paper-input>
				<paper-input id="create-date" label="Fecha" type="date"></paper-input>
				<paper-textarea id="create-description" label="Description" char-counter	></paper-textarea>
			</paper-dialog-scrollable>
			<div class="layout horizontal">
				<span class="flex"></span>
				<paper-button dialog-dismiss on-tap="_clearCourseCreateForm">Cancelar</paper-button>
				<paper-button raised autofocus on-tap="_saveNewCourse">Guardar <iron-icon icon="check"></iron-icon></paper-button>
			</div>
		</paper-dialog>


	</template>
	<script>
	Polymer({
		is: 'pfe-admin-courses',
		behaviors: [
			PfeBehaviors.ServLocationBehavior
		],
		properties: {
			pageRoute: {
				type: String,
				value: '/admin-courses'

			},

			courses: {
				type: Array,
				value: function() {
					return [];
				}
			},

			draft: {
				type: Array,
				value: function() {
					return [];
				}
			},

			active: {
				type: Array,
				value: function() {
					return [];
				}
			},

			blocked: {
				type: Array,
				value: function() {
					return [];
				}
			},

			editingCourse: {
				type: Boolean,
				value: false
			},

			token: {
				type: String
			}
		},

		observers: [
			'_coursesChanged(courses.*)'
		],

		listeners: {
			'delete-course': '_handleCourseDeletion',
			'edit-course': '_handleCourseEdition'
		},

		_pageAccessed() {
			// console.log('I accessed admin');
			if (!this.courses.length){
				this.$["xhr-element"].xhr({
					url: '/api/courses',
					method: 'GET',
					token: this.token || null
				});
			}
		},

		_openCreateDialog() {
			this.editingCourse = false;
			this.createError = false;
			this.editError = false;
			this.$["create-dialog"].open();
		},

		_saveNewCourse() {
			// Format date
			const tempDate = new Date( this.$["create-date"].value.replace( /(\d{2})-(\d{2})-(\d{4})/, "$2/$1/$3") ).getTime();

			const courseData = {
				name: this.$["create-name"].value,
				entity: this.$["create-entity"].value,
				url: this.$["create-url"].value,
				cost: this.$["create-cost"].value,
				description: this.$["create-description"].value,
				inscription_limit: this.$["create-limit"].value || 0,
				date: tempDate,

			}
			if (!this.editingCourse){
				this.$["xhr-element"].xhr({
					url: '/api/courses/create',
					method: 'POST',
					body: courseData,
					token: this.token || null
				});
			} else {
				this.editingCourse = false;
				courseData._id = this.courseBeingEdited;
				this.$["xhr-element"].xhr({
					url: '/api/courses/edit',
					method: 'PUT',
					body: courseData,
					token: this.token || null
				});
			}
		},

		_clearCourseCreateForm() {
			// Clear Creation Dialog form
			this.$["create-name"].value = '';
			this.$["create-entity"].value = '';
			this.$["create-url"].value = '';
			this.$["create-cost"].value = '';
			this.$["create-description"].value = '';
			this.$["create-date"].value = '';
			this.$["create-limit"].value = '';
		},

		_xhrDataReceived(res) {
			if(res.detail.reqId === '/api/courses/create'){
				this.push('courses', res.detail.data.data);
				this._clearCourseCreateForm();
				this.$["create-dialog"].close();
				this.fire('new-toast', {message: 'Curso creado correctamente.'});
			} else if (res.detail.reqId === '/api/courses'){
				this.courses = res.detail.data.data;
			} else if (res.detail.reqId === '/api/courses/delete'){
				if (res.detail.status === 200) {
					this[this.courseBeingDeleted.state].forEach((item, index) => {
						if (item._id === this.courseBeingDeleted._id) {
							this.splice(this.courseBeingDeleted.state, index, 1);
						}
					});
				}
			} else if(res.detail.reqId === '/api/courses/edit'){
				const data = res.detail.data.data;
				this.$["create-dialog"].close();
				this._clearCourseCreateForm();
				this[data.state].forEach((item, index) => {
					if (item._id === data._id) {
						this.set(data.state + '.'+ index, data);
					}
				});
				this.fire('new-toast', {message: 'Curso editado correctamente.'});
			}
		},

		_xhrError(err) {
			if (err.detail.reqId === '/api/courses/create') {
				this.createError = true;
			} else if (err.detail.reqId === '/api/courses/edit') {
				this.editError = true;
			}
		},

		_coursesChanged(changeRecord) {
			if (changeRecord.path === 'courses') {
				// Deal with initial course data crunch
				this._sortAllCourses();

			} else if (changeRecord.path === 'courses.splices') {
				// A new course has been added or deleted

				if (changeRecord.value.indexSplices[0].addedCount > 0) {
					// New course added
					this._pushCourse(this.courses[this.courses.length-1]);

				} else {
					// Course removed
					// Abstract - for the time being
					

				}
			}
		},

		_handleCourseEdition(e){
			this.courseBeingEdited = e.detail._id;
			this._populateCreateEditForm(e.detail);
			this.editingCourse = true;
			this.createError = false;
			this.editError = false;
			this.$["create-dialog"].open();
		},

		_populateCreateEditForm(data){
			this.$["create-name"].value = data.name;
			this.$["create-entity"].value = data.entity;
			this.$["create-url"].value = data.url;
			this.$["create-cost"].value = data.cost;
			this.$["create-description"].value = data.description;
			this.$["create-date"].value = this._formatDatetoInputValue(data.date);
			this.$["create-limit"].value = data.inscription_limit;
		},

		_handleCourseDeletion(e) {
			this.courseBeingDeleted = {
				_id: e.detail._id,
				state: e.detail.state
			};

			this.fire('open-confirmation-dialog', { node: this });
		},

		_handleConfirmationDialogAction(confirm) {
			if (confirm) {
				this.$["xhr-element"].xhr({
					url: '/api/courses/delete',
					method: 'DELETE',
					body: this.courseBeingDeleted,
					token: this.token || null
				});
			}
		},

		_sortAllCourses() {
			this.courses.forEach((item) => {
				this._pushCourse(item);
			});
		},

		_pushCourse(item) {
			if(item.state === 'draft') {
				this.push('draft', item);
			} else if (item.state === 'active') {
				this.push('active', item);
			} else {
				this.push('blocked', item);
			}
		},

		_formatDatetoInputValue(date) {
			var local = new Date(date);
			local.setMinutes(new Date(date).getMinutes() - new Date(date).getTimezoneOffset());
			return local.toJSON().slice(0,10);
		}
	});
	</script>
</dom-module>
